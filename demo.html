  <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro SIP Anura - UMD (retorno Promise)</title>
  <link rel="icon" href="https://anura.pe/wp-content/uploads/2015/11/logo-anura-300-tr.png" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.08);width:360px}
    label{display:block;margin-top:8px;font-weight:600}
    input{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
    button{margin-top:12px;width:100%;padding:10px;border-radius:8px;border:0;background:#007bff;color:#fff;cursor:pointer}
    .status{margin-top:12px;text-align:center;font-weight:700}
    .status.error{color:#c0392b}
    .status.ok{color:#2ecc71}
    pre{background:#f0f0f0;padding:8px;border-radius:6px;max-height:160px;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h3 style="margin:0 0 8px">Registrar cuenta SIP (Anura)</h3>

    <label for="user">Extensión SIP</label>
    <input id="user" placeholder="Ej: 1040" />

    <label for="password">Contraseña SIP</label>
    <input id="password" type="password" placeholder="Tu contraseña" />

    <button id="btn">Registrar cuenta</button>

    <div id="status" class="status"></div>

    <div style="margin-top:10px;font-size:12px;color:#555">
      <div><strong>Logs (consola):</strong></div>
      <pre id="log" aria-live="polite">—</pre>
    </div>
  </div>

  <!-- UMD SIP.js (versión estable que funciona como window.SIP) -->
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.15.10/dist/sip.min.js"></script>

  <script>
    // mostrar logs en la página además de consola
    const logEl = document.getElementById('log');
    function pageLog(...args){
      console.log(...args);
      const text = args.map(a => (typeof a === 'object'? JSON.stringify(a,null,2) : String(a))).join(' ');
      logEl.textContent = (logEl.textContent === '—' ? '' : logEl.textContent + '\n') + text;
    }

    // Mantener referencia a UA activo para poder detenerlo
    window.currentUA = null;

    /**
     * registerSIP(user, password, opts) -> Promise
     * Resuelve { status: 'registered' } o rechaza con objeto de error (incluye detalles en la consola).
     */
    function registerSIP(user, password, opts = {}) {
      const timeoutMs = opts.timeout || 15000;
      const domain = opts.domain || 'anura.empresas.anura.pe'; // sin puerto
      const wssServer = opts.wss || 'wss://sipwss.anura.pe';

      return new Promise((resolve, reject) => {
        if (!user || !password) {
          return reject({ error: 'missing_credentials' });
        }

        // Si había un UA anterior, detenerlo para evitar conflictos
        try {
          if (window.currentUA) {
            pageLog('[SIP] Deteniendo UA anterior...');
            window.currentUA.stop();
            window.currentUA = null;
          }
        } catch (e){ console.warn(e); }

        const uri = 'sip:' + user + '@' + domain;
        pageLog('[SIP] Creando UA con URI:', uri, 'WSS:', wssServer);

        // Crear UA usando la API UMD (v0.15.10)
        const ua = new SIP.UA({
          uri: uri,
          wsServers: [wssServer],
          authorizationUser: user,
          password: password,
          displayName: user,
          traceSip: true,
          register: true // pedir registro automáticamente
        });

        window.currentUA = ua;

        let finished = false;
        const timer = setTimeout(() => {
          if (finished) return;
          finished = true;
          pageLog('[SIP] Timeout de registro tras', timeoutMs, 'ms');
          // intentamos detener UA
          try { ua.stop(); } catch(e) {}
          reject({ error: 'timeout' });
        }, timeoutMs);

        // Eventos
        ua.on('registered', () => {
          if (finished) return;
          finished = true;
          clearTimeout(timer);
          pageLog('[SIP] Registrado ✅');
          resolve({ status: 'registered' });
        });

        ua.on('registrationFailed', (response, cause) => {
          if (finished) return;
          finished = true;
          clearTimeout(timer);

          // response puede ser objeto SIP o undefined; cause puede contener info adicional
          pageLog('[SIP] registrationFailed -> response:', response, 'cause:', cause);

          // Normalmente OpenSIPS devuelve un objeto con statusCode 403/401 en response.status_code o response.statusCode
          let details = { error: 'registrationFailed', cause: cause || null };

          try {
            // intentar extraer código si viene en response
            if (response && (response.status_code || response.statusCode)) {
              details.statusCode = response.status_code || response.statusCode;
            }
          } catch(e){}

          // detener agente
          try { ua.stop(); } catch(e) {}
          reject(details);
        });

        ua.on('unregistered', () => {
          pageLog('[SIP] unregistered');
        });

        ua.on('disconnected', () => {
          pageLog('[SIP] transport disconnected');
        });

        ua.on('connected', () => {
          pageLog('[SIP] transport connected');
        });

        // También loguear todos los mensajes SIP (traceSip:true envía logs a consola)
        pageLog('[SIP] UA iniciado — esperando registro...');
      });
    }

    // UI: conectar boton
    const btn = document.getElementById('btn');
    const statusEl = document.getElementById('status');
    btn.addEventListener('click', async () => {
      statusEl.textContent = '';
      statusEl.className = 'status';
      logEl.textContent = '—'; // limpiar logs de la UI

      const user = document.getElementById('user').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!user || !password) {
        statusEl.textContent = '⚠️ completa usuario y contraseña';
        statusEl.classList.add('error');
        return;
      }

      statusEl.textContent = '⏳ intentando registrar...';
      try {
        const res = await registerSIP(user, password, {
          domain: 'anura.empresas.anura.pe',
          wss: 'wss://sipwss.anura.pe',
          timeout: 20000
        });
        statusEl.textContent = '✅ registrado';
        statusEl.className = 'status ok';
        pageLog('[UI] register result:', res);
      } catch (err) {
        statusEl.textContent = '❌ Error al registrar: ' + (err.statusCode || err.error || JSON.stringify(err));
        statusEl.className = 'status error';
        pageLog('[UI] register error:', err);
        // mostrar en consola detalles útiles:
        console.error('Register error (detalles):', err);
      }
    });

    // Helper: permitir detener la UA manualmente desde consola si es necesario
    window.stopSIP = () => {
      if (window.currentUA) {
        try { window.currentUA.stop(); pageLog('[SIP] UA detenido manualmente'); } catch(e){ console.warn(e); }
        window.currentUA = null;
      } else pageLog('[SIP] No hay UA activo');
    };
  </script>
</body>
</html>
